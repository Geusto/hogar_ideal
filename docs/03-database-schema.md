# üóÑÔ∏è Esquema de Base de Datos - Hogar Ideal

## üìã Tabla de Contenidos

1. [Descripci√≥n General](#descripci√≥n-general)
2. [Entidades Principales](#entidades-principales)
3. [Relaciones](#relaciones)
4. [√çndices y Restricciones](#√≠ndices-y-restricciones)
5. [Datos de Ejemplo](#datos-de-ejemplo)
6. [Consultas Comunes](#consultas-comunes)

---

## üéØ Descripci√≥n General

La base de datos de "Hogar Ideal" est√° dise√±ada para gestionar un sistema inmobiliario completo, incluyendo propiedades, agentes, clientes, ventas y visitas. Utiliza MySQL 8.0 con codificaci√≥n UTF-8 y collation espa√±ol.

### üìä Caracter√≠sticas T√©cnicas
- **Motor**: InnoDB
- **Codificaci√≥n**: utf8mb4
- **Collation**: utf8mb4_spanish2_ci
- **Integridad Referencial**: Completa con FOREIGN KEYs
- **Auto-increment**: En todas las claves primarias

---

## üèóÔ∏è Entidades Principales

### üë§ Tabla: `agente`

**Descripci√≥n**: Almacena informaci√≥n de los agentes inmobiliarios del sistema.

```sql
CREATE TABLE `agente` (
  `id_agente` int NOT NULL AUTO_INCREMENT,
  `nombre_completo` varchar(100) NOT NULL,
  `telefono` varchar(20) NOT NULL,
  `email` varchar(100) DEFAULT NULL,
  `zona_asignada` varchar(50) NOT NULL,
  `activo` tinyint(1) DEFAULT '1',
  PRIMARY KEY (`id_agente`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_spanish2_ci;
```

#### üìã Campos de la Tabla

| Campo | Tipo | Descripci√≥n | Restricciones |
|-------|------|-------------|---------------|
| `id_agente` | INT | Identificador √∫nico del agente | AUTO_INCREMENT, PRIMARY KEY |
| `nombre_completo` | VARCHAR(100) | Nombre completo del agente | NOT NULL |
| `telefono` | VARCHAR(20) | N√∫mero de tel√©fono | NOT NULL |
| `email` | VARCHAR(100) | Correo electr√≥nico | UNIQUE |
| `zona_asignada` | VARCHAR(50) | Zona geogr√°fica asignada | NOT NULL |
| `activo` | TINYINT(1) | Estado activo/inactivo | DEFAULT 1 |

#### üìä Datos de Ejemplo
```sql
INSERT INTO `agente` VALUES
(1, 'Mar√≠a Garc√≠a', '098111111', 'maria.garcia@hogarideal.com', 'Punta del Este', 1),
(2, 'Juan L√≥pez', '098222222', 'juan.lopez@hogarideal.com', 'Montevideo Centro', 0),
(3, 'Pedro Mart√≠nez', '098333333', 'pedro.martinez@hogarideal.com', 'Carrasco', 1);
```

---

### üë• Tabla: `cliente`

**Descripci√≥n**: Gestiona informaci√≥n de clientes (compradores y vendedores).

```sql
CREATE TABLE `cliente` (
  `id_cliente` int NOT NULL AUTO_INCREMENT,
  `nombre_completo` varchar(100) NOT NULL,
  `direccion` varchar(200) NOT NULL,
  `telefono` varchar(20) NOT NULL,
  `email` varchar(100) DEFAULT NULL,
  `tipo` enum('Comprador','Vendedor','Ambos') NOT NULL,
  PRIMARY KEY (`id_cliente`),
  UNIQUE KEY `Email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_spanish2_ci;
```

#### üìã Campos de la Tabla

| Campo | Tipo | Descripci√≥n | Restricciones |
|-------|------|-------------|---------------|
| `id_cliente` | INT | Identificador √∫nico del cliente | AUTO_INCREMENT, PRIMARY KEY |
| `nombre_completo` | VARCHAR(100) | Nombre completo del cliente | NOT NULL |
| `direccion` | VARCHAR(200) | Direcci√≥n del cliente | NOT NULL |
| `telefono` | VARCHAR(20) | N√∫mero de tel√©fono | NOT NULL |
| `email` | VARCHAR(100) | Correo electr√≥nico | UNIQUE |
| `tipo` | ENUM | Tipo de cliente | 'Comprador', 'Vendedor', 'Ambos' |

#### üìä Datos de Ejemplo
```sql
INSERT INTO `cliente` VALUES
(1, 'Carlos M√©ndez', 'Av. Brasil 1234, Apt. 101', '099111111', 'carlos@email.com', 'Vendedor'),
(2, 'Ana Rodr√≠guez', 'Calle Colonia 567, Edificio Sol', '099222222', 'ana@email.com', 'Comprador'),
(3, 'Luisa Fern√°ndez', 'Bvar. Artigas 901, Casa 5', '099333333', 'luisa@email.com', 'Ambos');
```

---

### üè† Tabla: `propiedad`

**Descripci√≥n**: Almacena informaci√≥n detallada de las propiedades inmobiliarias.

```sql
CREATE TABLE `propiedad` (
  `id_propiedad` int NOT NULL AUTO_INCREMENT,
  `tipo` enum('casa','apartamento','terreno','local') NOT NULL,
  `direccion` varchar(200) NOT NULL,
  `habitaciones` int DEFAULT NULL,
  `banos` int DEFAULT NULL,
  `superficie` decimal(10,2) NOT NULL,
  `precio` decimal(12,2) NOT NULL,
  `portada` varchar(255) DEFAULT NULL,
  `estado` enum('disponible','vendida') DEFAULT 'disponible',
  `id_cliente_vendedor` int NOT NULL,
  `id_agente` int NOT NULL,
  PRIMARY KEY (`id_propiedad`),
  KEY `id_cliente_vendedor` (`id_cliente_vendedor`),
  KEY `id_agente` (`id_agente`),
  CONSTRAINT `propiedad_ibfk_1` FOREIGN KEY (`id_cliente_vendedor`) REFERENCES `cliente` (`id_cliente`),
  CONSTRAINT `propiedad_ibfk_2` FOREIGN KEY (`id_agente`) REFERENCES `agente` (`id_agente`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_spanish2_ci;
```

#### üìã Campos de la Tabla

| Campo | Tipo | Descripci√≥n | Restricciones |
|-------|------|-------------|---------------|
| `id_propiedad` | INT | Identificador √∫nico de la propiedad | AUTO_INCREMENT, PRIMARY KEY |
| `tipo` | ENUM | Tipo de propiedad | 'casa', 'apartamento', 'terreno', 'local' |
| `direccion` | VARCHAR(200) | Direcci√≥n de la propiedad | NOT NULL |
| `habitaciones` | INT | N√∫mero de habitaciones | NULL |
| `banos` | INT | N√∫mero de ba√±os | NULL |
| `superficie` | DECIMAL(10,2) | Superficie en m¬≤ | NOT NULL |
| `precio` | DECIMAL(12,2) | Precio de la propiedad | NOT NULL |
| `portada` | VARCHAR(255) | Ruta de la imagen de portada | NULL |
| `estado` | ENUM | Estado de la propiedad | 'disponible', 'vendida' |
| `id_cliente_vendedor` | INT | ID del cliente vendedor | FOREIGN KEY |
| `id_agente` | INT | ID del agente asignado | FOREIGN KEY |

#### üìä Datos de Ejemplo
```sql
INSERT INTO `propiedad` VALUES
(1, 'casa', 'Calle Los Pinos 123', 4, 3, '180.50', '350000.00', NULL, 'vendida', 1, 1),
(2, 'apartamento', 'Av. 18 de Julio 567', 2, 1, '75.25', '120000.00', NULL, 'disponible', 3, 2),
(3, 'terreno', 'Av. Bolivia 890', 2, 1, '300.00', '200000.00', NULL, 'disponible', 3, 3),
(4, 'casa', 'calle 45 #1a-24', 2, 2, '200.00', '89000000.00', NULL, 'vendida', 1, 1),
(5, 'apartamento', 'Edificio trin Apto 12a', 2, 2, '100.00', '450000.00', 'uploads/6879b718c5263_cat.png', 'disponible', 3, 1);
```

---

### üí∞ Tabla: `venta`

**Descripci√≥n**: Registra las transacciones de venta de propiedades.

```sql
CREATE TABLE `venta` (
  `id_venta` int NOT NULL AUTO_INCREMENT,
  `fecha_venta` date NOT NULL,
  `precio_final` decimal(12,2) NOT NULL,
  `comision` decimal(10,2) NOT NULL,
  `metodo_pago` enum('contado','credito') NOT NULL,
  `id_propiedad` int NOT NULL,
  `id_cliente_comprador` int NOT NULL,
  `id_cliente_vendedor` int NOT NULL,
  `id_agente` int NOT NULL,
  PRIMARY KEY (`id_venta`),
  KEY `id_propiedad` (`id_propiedad`),
  KEY `id_cliente_comprador` (`id_cliente_comprador`),
  KEY `id_cliente_vendedor` (`id_cliente_vendedor`),
  KEY `id_agente` (`id_agente`),
  CONSTRAINT `venta_ibfk_1` FOREIGN KEY (`id_propiedad`) REFERENCES `propiedad` (`id_propiedad`),
  CONSTRAINT `venta_ibfk_2` FOREIGN KEY (`id_cliente_comprador`) REFERENCES `cliente` (`id_cliente`),
  CONSTRAINT `venta_ibfk_3` FOREIGN KEY (`id_cliente_vendedor`) REFERENCES `cliente` (`id_cliente`),
  CONSTRAINT `venta_ibfk_4` FOREIGN KEY (`id_agente`) REFERENCES `agente` (`id_agente`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_spanish2_ci;
```

#### üìã Campos de la Tabla

| Campo | Tipo | Descripci√≥n | Restricciones |
|-------|------|-------------|---------------|
| `id_venta` | INT | Identificador √∫nico de la venta | AUTO_INCREMENT, PRIMARY KEY |
| `fecha_venta` | DATE | Fecha de la venta | NOT NULL |
| `precio_final` | DECIMAL(12,2) | Precio final de la venta | NOT NULL |
| `comision` | DECIMAL(10,2) | Comisi√≥n del agente | NOT NULL |
| `metodo_pago` | ENUM | M√©todo de pago | 'contado', 'credito' |
| `id_propiedad` | INT | ID de la propiedad vendida | FOREIGN KEY |
| `id_cliente_comprador` | INT | ID del cliente comprador | FOREIGN KEY |
| `id_cliente_vendedor` | INT | ID del cliente vendedor | FOREIGN KEY |
| `id_agente` | INT | ID del agente que realiz√≥ la venta | FOREIGN KEY |

#### üìä Datos de Ejemplo
```sql
INSERT INTO `venta` VALUES
(1, '2024-06-20', '340000.00', '10200.00', 'contado', 1, 2, 1, 1);
```

---

### üìÖ Tabla: `visita`

**Descripci√≥n**: Gestiona las visitas programadas a las propiedades.

```sql
CREATE TABLE `visita` (
  `id_visita` int NOT NULL AUTO_INCREMENT,
  `fecha_hora` datetime NOT NULL,
  `estado` enum('programada','realizada','cancelada') DEFAULT 'programada',
  `comentarios` text,
  `id_cliente` int NOT NULL,
  `id_propiedad` int NOT NULL,
  `id_agente` int NOT NULL,
  PRIMARY KEY (`id_visita`),
  KEY `id_cliente` (`id_cliente`),
  KEY `id_propiedad` (`id_propiedad`),
  KEY `id_agente` (`id_agente`),
  CONSTRAINT `visita_ibfk_1` FOREIGN KEY (`id_cliente`) REFERENCES `cliente` (`id_cliente`),
  CONSTRAINT `visita_ibfk_2` FOREIGN KEY (`id_propiedad`) REFERENCES `propiedad` (`id_propiedad`),
  CONSTRAINT `visita_ibfk_3` FOREIGN KEY (`id_agente`) REFERENCES `agente` (`id_agente`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_spanish2_ci;
```

#### üìã Campos de la Tabla

| Campo | Tipo | Descripci√≥n | Restricciones |
|-------|------|-------------|---------------|
| `id_visita` | INT | Identificador √∫nico de la visita | AUTO_INCREMENT, PRIMARY KEY |
| `fecha_hora` | DATETIME | Fecha y hora de la visita | NOT NULL |
| `estado` | ENUM | Estado de la visita | 'programada', 'realizada', 'cancelada' |
| `comentarios` | TEXT | Comentarios sobre la visita | NULL |
| `id_cliente` | INT | ID del cliente que visita | FOREIGN KEY |
| `id_propiedad` | INT | ID de la propiedad a visitar | FOREIGN KEY |
| `id_agente` | INT | ID del agente que acompa√±a | FOREIGN KEY |

#### üìä Datos de Ejemplo
```sql
INSERT INTO `visita` VALUES
(1, '2024-06-20 15:30:00', 'programada', NULL, 2, 1, 1);
```

---

## üîó Relaciones

### Diagrama de Relaciones
```
agente (1) ‚Üê‚Üí (N) propiedad
cliente (1) ‚Üê‚Üí (N) propiedad (como vendedor)
cliente (1) ‚Üê‚Üí (N) venta (como comprador)
cliente (1) ‚Üê‚Üí (N) venta (como vendedor)
agente (1) ‚Üê‚Üí (N) venta
propiedad (1) ‚Üê‚Üí (N) venta
cliente (1) ‚Üê‚Üí (N) visita
propiedad (1) ‚Üê‚Üí (N) visita
agente (1) ‚Üê‚Üí (N) visita
```

### Relaciones Espec√≠ficas

#### 1. Agente ‚Üí Propiedad
- Un agente puede gestionar m√∫ltiples propiedades
- Una propiedad tiene un solo agente asignado
- **Clave for√°nea**: `propiedad.id_agente ‚Üí agente.id_agente`

#### 2. Cliente ‚Üí Propiedad (Vendedor)
- Un cliente puede vender m√∫ltiples propiedades
- Una propiedad tiene un solo vendedor
- **Clave for√°nea**: `propiedad.id_cliente_vendedor ‚Üí cliente.id_cliente`

#### 3. Venta (Relaciones M√∫ltiples)
- **Propiedad**: Una propiedad puede tener una venta
- **Cliente Comprador**: Un cliente puede comprar m√∫ltiples propiedades
- **Cliente Vendedor**: Un cliente puede vender m√∫ltiples propiedades
- **Agente**: Un agente puede realizar m√∫ltiples ventas

#### 4. Visita (Relaciones M√∫ltiples)
- **Cliente**: Un cliente puede hacer m√∫ltiples visitas
- **Propiedad**: Una propiedad puede tener m√∫ltiples visitas
- **Agente**: Un agente puede acompa√±ar m√∫ltiples visitas

---

## üîç √çndices y Restricciones

### Claves Primarias
```sql
-- Todas las tablas tienen AUTO_INCREMENT en su PK
agente.id_agente
cliente.id_cliente
propiedad.id_propiedad
venta.id_venta
visita.id_visita
```

### Claves √önicas
```sql
-- Emails √∫nicos
agente.email
cliente.email
```

### Claves For√°neas
```sql
-- Propiedad
propiedad.id_cliente_vendedor ‚Üí cliente.id_cliente
propiedad.id_agente ‚Üí agente.id_agente

-- Venta
venta.id_propiedad ‚Üí propiedad.id_propiedad
venta.id_cliente_comprador ‚Üí cliente.id_cliente
venta.id_cliente_vendedor ‚Üí cliente.id_cliente
venta.id_agente ‚Üí agente.id_agente

-- Visita
visita.id_cliente ‚Üí cliente.id_cliente
visita.id_propiedad ‚Üí propiedad.id_propiedad
visita.id_agente ‚Üí agente.id_agente
```

### √çndices Secundarios
```sql
-- √çndices en claves for√°neas para mejorar rendimiento
propiedad.id_cliente_vendedor
propiedad.id_agente
venta.id_propiedad
venta.id_cliente_comprador
venta.id_cliente_vendedor
venta.id_agente
visita.id_cliente
visita.id_propiedad
visita.id_agente
```

---

## üìä Consultas Comunes

### 1. Propiedades Disponibles con Informaci√≥n del Agente
```sql
SELECT 
    p.*,
    a.nombre_completo as agente_nombre,
    c.nombre_completo as vendedor_nombre
FROM propiedad p
JOIN agente a ON p.id_agente = a.id_agente
JOIN cliente c ON p.id_cliente_vendedor = c.id_cliente
WHERE p.estado = 'disponible'
ORDER BY p.precio ASC;
```

### 2. Ventas por Agente con Comisiones
```sql
SELECT 
    a.nombre_completo as agente,
    COUNT(v.id_venta) as total_ventas,
    SUM(v.precio_final) as total_ventas_monto,
    SUM(v.comision) as total_comisiones
FROM agente a
LEFT JOIN venta v ON a.id_agente = v.id_agente
WHERE a.activo = 1
GROUP BY a.id_agente, a.nombre_completo
ORDER BY total_comisiones DESC;
```

### 3. Propiedades por Tipo y Estado
```sql
SELECT 
    tipo,
    estado,
    COUNT(*) as cantidad,
    AVG(precio) as precio_promedio,
    MIN(precio) as precio_minimo,
    MAX(precio) as precio_maximo
FROM propiedad
GROUP BY tipo, estado
ORDER BY tipo, estado;
```

### 4. Visitas Programadas para Hoy
```sql
SELECT 
    v.fecha_hora,
    c.nombre_completo as cliente,
    p.direccion as propiedad,
    a.nombre_completo as agente
FROM visita vi
JOIN cliente c ON vi.id_cliente = c.id_cliente
JOIN propiedad p ON vi.id_propiedad = p.id_propiedad
JOIN agente a ON vi.id_agente = a.id_agente
WHERE DATE(vi.fecha_hora) = CURDATE()
AND vi.estado = 'programada'
ORDER BY vi.fecha_hora;
```

### 5. Top 5 Propiedades M√°s Caras
```sql
SELECT 
    p.tipo,
    p.direccion,
    p.precio,
    a.nombre_completo as agente,
    c.nombre_completo as vendedor
FROM propiedad p
JOIN agente a ON p.id_agente = a.id_agente
JOIN cliente c ON p.id_cliente_vendedor = c.id_cliente
WHERE p.estado = 'disponible'
ORDER BY p.precio DESC
LIMIT 5;
```

---

## üõ†Ô∏è Mantenimiento de la Base de Datos

### Respaldos
```bash
# Respaldar la base de datos
mysqldump -u usuario -p hogar_ideal > backup_hogar_ideal.sql

# Restaurar la base de datos
mysql -u usuario -p hogar_ideal < backup_hogar_ideal.sql
```

### Optimizaci√≥n
```sql
-- Analizar tablas para optimizar √≠ndices
ANALYZE TABLE agente, cliente, propiedad, venta, visita;

-- Optimizar tablas
OPTIMIZE TABLE agente, cliente, propiedad, venta, visita;
```

### Monitoreo
```sql
-- Verificar tama√±o de las tablas
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.tables
WHERE table_schema = 'hogar_ideal'
ORDER BY (data_length + index_length) DESC;

-- Verificar fragmentaci√≥n
SHOW TABLE STATUS FROM hogar_ideal;
```

---

## üìà Consideraciones de Rendimiento

### 1. √çndices Recomendados
- Todos los campos de b√∫squeda frecuente
- Campos de ordenamiento (precio, fecha)
- Campos de filtrado (estado, tipo)

### 2. Particionamiento
Para bases de datos grandes, considerar:
- Particionar por fecha en tabla `venta`
- Particionar por zona en tabla `agente`

### 3. Optimizaci√≥n de Consultas
- Usar LIMIT en consultas de listado
- Implementar paginaci√≥n
- Cachear consultas frecuentes

---

## üîí Seguridad

### 1. Permisos de Usuario
```sql
-- Crear usuario con permisos limitados
CREATE USER 'hogar_ideal_user'@'localhost' IDENTIFIED BY 'password_seguro';
GRANT SELECT, INSERT, UPDATE, DELETE ON hogar_ideal.* TO 'hogar_ideal_user'@'localhost';
FLUSH PRIVILEGES;
```

### 2. Validaci√≥n de Datos
- Validar todos los datos de entrada
- Usar prepared statements
- Escapar datos de salida

### 3. Auditor√≠a
```sql
-- Crear tabla de auditor√≠a (opcional)
CREATE TABLE auditoria (
    id INT AUTO_INCREMENT PRIMARY KEY,
    tabla VARCHAR(50),
    accion ENUM('INSERT', 'UPDATE', 'DELETE'),
    registro_id INT,
    usuario VARCHAR(50),
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## üìö Pr√≥ximos Pasos

Para implementar mejoras en la base de datos:

1. **√çndices adicionales** seg√∫n patrones de uso
2. **Procedimientos almacenados** para operaciones complejas
3. **Triggers** para auditor√≠a autom√°tica
4. **Vistas** para consultas frecuentes
5. **Replicaci√≥n** para alta disponibilidad

Para m√°s informaci√≥n sobre implementaciones espec√≠ficas, consulta:
- [Documentaci√≥n de Entidades](04-entities/)
- [Funciones Helper](05-functions/)
- [Gu√≠a MVC](02-mvc-pattern.md) 